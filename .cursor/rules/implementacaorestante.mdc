---
description: Itens faltantes ou de atenção crítica  
alwaysApply: true
---
                                                                                                                                                                                                                                                                                                             
| **Tributário / Fiscal**      | - Cálculo e destaque do **FCP** (Fundo de Combate à Pobreza) para o RJ quando aplicável.<br>- Suporte explícito a **ICMS-ST** (Substituição Tributária) com cálculo correto da base ST, abatimento ou redução, e preenchimento dos campos `<vBCST>`, `<vICMSST>`. <br>- Tratamento de **DIFAL / ICMS UFDest** para vendas interestaduais a consumidor final (campo `<ICMSUFDest>`). <br>- Verificar se o motor de cálculo de ICMS já considera frete, seguro e outras despesas acessórias. <br>- Tabelas de alíquotas estaduais do RJ devem ser mantidas atualizadas (incluindo MVA por NCM). <br>- Verificar regime tributário (Simples Nacional / Presumido / Real) e usar os CST/CSOSN corretos. <br>- Prever contigência (EPEC, FS-DA) para NF-e, caso a SEFAZ fique indisponível. <br>- Política de retenção de documentos fiscais (XMLs e PDFs) por prazo legal mínimo (11 anos, por exemplo). |
| **Integração / WebServices** | - URLs corretos dos WebServices de SEFAZ-RJ (autorização, inutilização, consulta, evento, distribuição DFe). <br>- Suporte a ambiente de homologação vs produção com certificados diferentes e URIs distintas. <br>- Tratamento de erros ou rejeições do WebService (time-out, retry, fallback). <br>- Suporte a SOAP com MTLS se exigido pela SEFAZ (mutual TLS). <br>- Verificação de schema XSD correto antes do envio (validar XML gerado contra XSD). <br>- Sistema de fallback / fila de envio em caso de falha temporária da SEFAZ.                                                                                                                                                                                                                                                                                                                                                           |
| **Assinatura + Certificado** | - Suporte robusto para certificados A3/token ou HSM (não apenas A1 arquivo). <br>- Proteção de chave privada (não armazenar arquivo .pfx em repositório, usar armazenamento seguro). <br>- Rotina de leitura e uso do certificado, inclusive recarga ou cachê seguro. <br>- Verificar se a assinatura gerada está conforme padrão XML DSig exigido pela NF-e (canonicalization, transforms, referência ao `infNFe`, etc.).                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **DANFE / Impressão**        | - Gerar código de barras (CODE-128C) da chave de acesso no DANFE. <br>- Correto layout do DANFE conforme Anexo III do MOC (margens, posições, QR Code onde aplicável). <br>- Incluir destaque de FCP quando aplicável no DANFE. <br>- Impressão da hora de saída (quando for operação de saída). <br>- Layout preparado para, futuramente, exibir campos de IBS / CBS (caso for migrar).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **NFS-e (Serviços)**         | - Ajustes específicos para prefeitura de Niterói: endpoint municipal, campos obrigatórios, autenticação. <br>- Emissão de RPS → envio ao provedor municipal → consulta e cancelamento de NFS-e. <br>- Cálculo de ISS municipal, retenções (PIS, COFINS, IR, CSLL, INSS) se aplicável no serviço. <br>- Suporte a padrões ABRASF e versão nacional, com fallback municipal.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Arquitetura / API**        | - Endpoints REST claros: `/api/nfe/emitir`, `/api/nfe/consultar`, `/api/nfse/emitir`, etc. <br>- Normalizar o payload recebido: validações de entrada / DTOs. <br>- Retorno consistente (JSON) com status, XML assinado, PDF (base64), protocolização e mensagens de erro. <br>- Modularização por provedor/município/UF — para que você adicione novos estados facilmente. <br>- Middleware de autenticação/autorização para evitar emissões não autorizadas. <br>- Logs, auditoria, rastreamento de falhas do sistema e dos WebServices externos.                                                                                                                                                                                                                                                                                                                                                  |
| **Testes / Homologação**     | - Testes automatizados unitários e de integração para todos os fluxos (emissão, cancelamento, rejeição). <br>- Banco homolog para simular respostas da SEFAZ. <br>- Checklist de homologação (emitir NF-e, cancelar, inutilizar, CC-e). <br>- Simulações de casos extremos (rejeições, falhas de comunicação, timeout).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Segurança / Operações**    | - Proteção dos certificados e segredos no ambiente (não em claro no código). <br>- Backup e retenção de XMLs/PDFs emitidos e consumidos. <br>- Monitoramento de disponibilidade dos serviços da SEFAZ. <br>- Planejamento de alta carga / concorrência (se for uso em produção com muitos clientes). <br>- Versionamento do XSD e controle de atualização automática (verificar quando há novas NTs).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Conformidade futura**      | - Preparar campos adicionais para **IBS / CBS** (reforma tributária) no XML e PDF. <br>- Tornar o motor fiscal extensível para novas regras estaduais e federais. <br>- Módulo de importação/atualização de tabelas fiscais (alíquotas, MVA, CST) via web (SEFAZ ou repositório oficial).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
